---
title: "Speed Tests"
author: "Nick O'Brien"
date: "20/07/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## SLiM Speed

Now that my models are approaching completion, I am needing to figure out exactly how long everything will take to run and optimise as much as possible. From my previous tests (and the SLiM manual) I've found that population size and recombination contribute the most to run time, but I've also now found that my stabilising selection model has a huge performance impact. To find this, I ran two jobs on Tinaroo: simple scripts that ran one 8 trait null or stabilising selection model with worst case scenario parameters (0.5 recombination between regions, high population size, large recombination rate etc., all pleiotropic mutations). That script is below:

```{r speedtestscript, eval=FALSE}

# Worst case scenario test run for 8T Null

system.time(system("/home/$USER/SLiM/slim -s 123 -d rregion=0.5 -d Ne=10000 -d QTL_cov=0.5 -d pleiorate=1.0 -d delmu=0.0 -d rwide=1.346e-5 /home/$USER/SLiM/Scripts/null8T100L_nowrite.slim"))


# Worst case scenario test run for 8T Selection

system.time(system("/home/$USER/SLiM/slim -s 123 -d rregion=0.5 -d Ne=10000 -d QTL_cov=0.5 -d pleiorate=1.0 -d delmu=0.0 -d rwide=1.346e-5 /home/$USER/SLiM/Scripts/stabsel_recom_8T100L_nowrite.slim"))


```

## Results

I found that the null model with worst case scenario parameters takes 26655.862 seconds, or ~7.41 hours.
This is fine - I'll be able to run heaps of things,
The stabilising selection model is more concerning - it didn't finish in the 24 hours I gave it, so I may have to be very careful with how many runs I do. If one model takes a week that means 5 will take 5 weeks. If we're running on enough cores this may not be a problem, but if we're doing 10,000 models and we want to take ~4 weeks to run everything, that would be 2500 cores we'd need, which is way may than the system can reasonably provide (I think anyway - that's close to half of the total cores available on the system, 5856). 

I'll need to run this thing to its finish state to determine how long it will take - if it's well under a week per model it should be fine, otherwise I'll have to consider what can be done to improve performance.
Since SLiM's variance and covariance functions don't support matrix inputs, I can't vectorise my phenotypes, which is a huge pain and may have been a way to get some speed.  